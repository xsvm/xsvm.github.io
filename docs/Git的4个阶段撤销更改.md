# Git的4个阶段撤销更改
在版本控制领域，Git自诞生已过去12年，网上相关介绍文章繁多，但仍有不少人未能完全掌握其功能。本文将基于单分支（即主分支master）场景，通俗讲解在Git中不同阶段如何撤销更改，帮助初学者快速上手，且不涉及复杂分支与标签操作。

## 一、Git基本概念
### （一）工作流程的3个步骤
正常的Git工作流包含3个核心步骤：
1. `git add .`：该命令用于将所有文件添加到暂存区。
2. `git commit -m "comment"`：把暂存区的文件提交到本地仓库，其中`-m`后的双引号内为本次提交的注释信息，方便记录提交内容。
3. `git push`：将本地仓库的文件推送至远程仓库。

### （二）4个区
与传统版本管理工具（如SVN）相比，Git多了暂存区（Stage）这一概念，这也是其令人费解之处。对于初学者，知晓4个区即可：
1. 工作区（Working Area）：日常编辑文件的地方，所有文件的初始修改都在这里进行。
2. 暂存区（Stage）：可看作是文件提交前的临时存储区域，通过`git add`命令将工作区的修改添加到这里。
3. 本地仓库（Local Repository）：用于本地保存项目的历史版本，执行`git commit`命令后，暂存区的文件就会提交到本地仓库。
4. 远程仓库（Remote Repository）：团队成员共享代码的地方，通过`git push`和`git pull`等命令与本地仓库进行交互。

### （三）5种状态
随着文件在4个区中的流转，会产生5种状态：
1. 未修改（Origin）：文件未进行任何修改的初始状态。
2. 已修改（Modified）：文件在工作区被修改，但尚未添加到暂存区。
3. 已暂存（Staged）：文件已通过`git add`命令添加到暂存区。
4. 已提交（Committed）：文件从暂存区提交到了本地仓库。
5. 已推送（Pushed）：文件从本地仓库推送到了远程仓库。

## 二、检查修改
在进行撤销操作前，需先了解如何检查不同阶段的修改内容，这可通过`diff`命令结合不同参数实现。
### （一）已修改，未暂存
当文件处于已修改但未暂存状态时，运行`git diff`命令，可查看工作区中文件相对于暂存区的修改情况。例如，在文件`index.md`开头第2行添加“1234”后，执行`git diff`，输出结果会详细展示文件的修改部分，包括修改的行以及具体内容变化。

### （二）已暂存，未提交
执行`git add .`将修改添加到暂存区后，再执行`git diff`不会显示任何结果，因为`git diff`默认比较的是工作区和暂存区的差异。此时，若想查看暂存区和本地仓库之间的差异，需使用`git diff --cached`命令，它会展示暂存区相对于本地仓库的文件修改情况。

### （三）已提交，未推送
把修改从暂存区提交到本地仓库后，执行`git diff --cached`看不到差异。若要查看本地仓库与远程仓库（假设远程仓库地址为`origin`，分支为`master`）之间的差异，可使用`git diff master origin/master`命令，其中`master`代表本地仓库主分支，`origin/master`代表远程仓库主分支。

## 三、撤销修改
### （一）已修改，未暂存
若文件仅在编辑器中修改，尚未执行`git add .`，此时文件处于工作区，可使用以下两种方式撤销修改：
1. `git checkout .`：该命令会撤销工作区中所有文件的修改，使其恢复到上一次`git add`或`git commit`时的状态。
2. `git reset --hard`：这是一个强大的命令，不仅会撤销工作区的修改，还会将暂存区的内容也恢复到上一次提交的状态，一步到位将文件恢复到未修改状态。可以理解为`git add .`的反向操作，`git add .`是让修改向前进入暂存区，而`git checkout .`是让修改向后退回未修改状态。

### （二）已暂存，未提交
当执行了`git add .`，但还未执行`git commit -m "comment"`时，若想撤销，有两种方法：
1. 分步操作：先执行`git reset`，它会把修改退回到`git add .`之前的状态，即文件变为已修改未暂存状态；接着执行`git checkout .`，将文件恢复到未修改状态。
2. 一步到位：直接使用`git reset --hard`命令，可直接把修改完全恢复到未修改状态。

### （三）已提交，未推送
如果既执行了`git add .`，又执行了`git commit`，代码已进入本地仓库，此时后悔了，可使用`git reset --hard origin/master`命令。该命令会从远程仓库（`origin/master`）拉取代码覆盖本地仓库，从而撤销本地仓库的错误提交。

### （四）已推送
若代码已经`git add`、`git commit`且`git push`到远程仓库，想要恢复，可按以下步骤操作：
1. 执行`git reset --hard HEAD^`：`HEAD^`表示上一个提交版本，该命令会将本地仓库恢复到上一次提交前的状态。
2. 执行`git push -f`：由于本地仓库和远程仓库已不一致，使用`git push -f`命令强制将本地仓库的内容推送到远程仓库，覆盖远程仓库的错误提交。不过，这种强制推送操作需谨慎使用，因为可能会覆盖其他成员的提交。

## 四、总结
在上述4种不同状态下的撤销操作中，`git reset --hard`命令发挥了关键作用，前两种状态下的用法基本一致。掌握好这个命令，在使用Git进行版本控制时，就不必过于担心提交错误的问题。 